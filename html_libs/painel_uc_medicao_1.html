<script type="text/javascript">
    

    /*
     * DESENHAR GRÁFICOS
     * 
     */
    function drawChart() {
    
        var data = new google.visualization.DataTable();
        data.addColumn('date', 'Datas'); // Implicit domain label col.
        data.addColumn('number', 'Medido'); // Implicit series 1 data col.
        data.addColumn({type:'string', role:'annotation'}); // annotation role col.
        //data.addColumn({type:'string', role:'annotationText'}); // annotationText col.
        data.addColumn({type:'string', role:'tooltip', 'p': {'html': true}}); // annotationText col.
        data.addRows([{CHARTDATA}]);
        var options = {
            title: 'Leituras do Hidrômetro',
            legend: { position: "none" },
            hAxis: {title: 'Dias do período', titleTextStyle: {color: '#47A3DA'}, baselineColor: 'blue', format:'d MMM y', minValue: new Date({DATA_INIC})},
            vAxis: {titleTextStyle: {color: '#47A3DA'}}, pointSize: 5,
            curveType: 'function',
            tooltip: {isHtml: true},
            //colors: ['MediumSeaGreen','#D9EDF7','#DB261D','DarkGreen','#DB261D','Lime','Chartreuse','GreenYellow','YellowGreen','OliveDrab','DarkOliveGreen','Olive','','','',''] //ORIGINAL
            colors: ['#DB261D','Lime','Chartreuse','GreenYellow','YellowGreen','OliveDrab','DarkOliveGreen','Olive','','','',''] 
        };

        var chart = new google.visualization.LineChart(document.getElementById('chart_med'));
        chart.draw(data, options);
    }
    /*
     * Gráfico de META
     * 
     */
     function drawChart2() {
        
         var data = google.visualization.arrayToDataTable([
                             ['x', '{TIPOMEDIDA}', { role: 'style' }, { role: 'annotation' }],
                             ['{REFERENCIA}', {CON_PERIODO}, '#47A3DA', '{REFERENCIA}\n {CON_PERIODO} {TIPOMEDIDA}'], // RGB value
                             ['META', {META}, '#DB261D', 'META {META} {TIPOMEDIDA}'], // English color name
                     ]);
        var options = {
            hAxis: { titleTextStyle: {color: '#47A3DA'}, baselineColor: 'blue', format:'d MMM y', minValue: new Date({DATA_INIC})},
            vAxis: {titleTextStyle: {color: '#47A3DA'}}, pointSize: 5,
            //tooltip: {isHtml: true},
            legend: { position: "none" }
            //colors: ['MediumSeaGreen','#D9EDF7','#DB261D','DarkGreen','#DB261D','Lime','Chartreuse','GreenYellow','YellowGreen','OliveDrab','DarkOliveGreen','Olive','','','',''] //ORIGINAL
            //colors: ['GreenYellow','#DB261D','Chartreuse','GreenYellow','YellowGreen','OliveDrab','DarkOliveGreen','Olive','','','',''] 
        };

        var chart = new google.visualization.ColumnChart(document.getElementById('chart_meta'));
        chart.draw(data, options);
    }           
    
     /*
     * Gráfico de Comparação
     * 
     */
    function drawComparacao(consumo){
        
        var data = google.visualization.arrayToDataTable([
                ['Descricao', '', { role: 'style' }, { role: 'annotation' } ],
                ['Sua média', consumo, '#00B2EC', '{REFERENCIA} - RGI {UCNOME} : '+ consumo + 'L '],
                ['{A}', 0, '#fff', '' ],
                ['NTS 181', 50, '#ABC7F0', 'Edifícios públicos, comerciais, escritórios (1) : 50L ( 8h )' ],
                ['ONU', 110, '#0086CD', 'Organizações das Nações Unidas : 110L ( 24h )' ],
                ['NTS 181', 120, '#00A853', 'Casas populares ou rurais (2) : 120L ( 24h )' ],
                ['NTS 181', 150, 'gold', 'Residências (2) : 150L ( 24h )' ],
                ['NTS 181', 200, 'orange', 'Apartamentos (2) : 200L ( 24h )' ],
                ['NTS 181', 300, '#E62117', 'Residências de luxo : 300L ( 24h )' ],
                ['EUA', 350, '#D41E1B', 'Média do Norte Americano : 350L ( 24h )' ],
                ['EUR', 200, '#30368A', 'Média do Europeu : 200L ( 24h )' ],
                ['BRA', 187, '#117539', 'Média do Brasileiro : 187L ( 24h )' ]
                
        ]);
        var options = {
                title: "",
                height: 550,
                bar: {groupWidth: "97%"},
                legend: { position: "none" },
                hAxis: {gridlines : {count : 10}},
                chartArea: {'width': '70%', 'height': '80%'},
                annotations: {
                    //highContrast: false,
                    alwaysOutside: false,
                    textStyle: {
                        fontSize: 15,
                        color: '#666',
                        

                    }
                }
            };
        var chart = new google.visualization.BarChart(document.getElementById('compara_chart'));
        chart.draw(data, options);
        
    }
    
    /*
     * Desenhar Gráfico de Datas
     */
    function drawModalChart(begin, end, value) {
        
        var dataTable = new google.visualization.DataTable();
        dataTable.addColumn({ type: 'date', id: 'Date' });
        dataTable.addColumn({ type: 'number', id: 'Periodo' });
        
        for(var i = 0; i < end; i++){
             
            var tmp_date = new Date(begin.getTime() - (i * 24 * 60 * 60 * 1000));
            
            dataTable.addRow( [tmp_date, value] );
               
        }

        var chart = new google.visualization.Calendar(document.getElementById('modal-chart'));

        var options = {
            title: "Dias do período",
            noDataPattern: {
                backgroundColor: '#fff',
                color: '#D9EDF7'
            },
            calendar: {
                daysOfWeek: 'DSTQQSS',
            },
            colorAxis: {
                colors: ['#47A3DA', '#47A3DA']
            }
       };

       chart.draw(dataTable, options);
       
   }
      
    $(document).ready(function(){
        
        $('.muda-periodo').click(function(e){
        
            //alert("sad");
            e.preventDefault();
            var href = $(this).attr('href');
            $('#conteudo').load(href, function(){
                drawChart();
                drawChart2();
            });
        
        });
        /*
         * Tooltip do Bootstrap
         */
        
        $('[data-toggle="tooltip"]').tooltip(); 
        
        /*
         * Calcular médias ao alterar campos
         * @file : html_libs/painel_uc_medicao_3.html
         * 
         */
        $('.dias-ut').change(function(){
            
            var dias = $(this).val();
            var index= $(this).attr('z-index');
            var cons = parseInt($('input[name=litros-' + index + ']').val());
            var fixa = parseInt($('#fixa').val());
            var flut = parseInt($('.pop-flu[z-index=' + index + ']').val());
            var perm = parseInt($('.dias-perm[z-index=' + index + ']').val());
            if(perm >= dias) $('.dias-perm[z-index=' + index + ']').val(dias);
            if($(this).val() > parseInt($(this).attr('max'))) $(this).val($(this).attr('max'));
            var med_dia = (dias > 0 ) ? cons/dias : cons;
            var med_pes = cons/(fixa * dias + flut * perm);
            $('#TR-D'+ index).html(Math.round(med_dia * 100) / 100);
            $('#TR-P'+ index).html(Math.round(med_pes * 100) / 100);
            atualizaTotal();
            
        });
        
        $('.pop-flu').change(function(){
            
            var index= $(this).attr('z-index');
            var dias = parseInt($('.dias-ut[z-index=' + index + ']').val());
            var cons = parseInt($('input[name=litros-' + index + ']').val());
            var fixa = parseInt($('#fixa').val());
            var flut = parseInt($(this).val());
            var perm = parseInt($('.dias-perm[z-index=' + index + ']').val());
            var med_dia = (dias > 0 ) ? cons/dias : cons;
            var med_pes = cons/(fixa * dias + flut * perm);
            $('#TR-D'+ index).html(Math.round(med_dia * 100) / 100);
            $('#TR-P'+ index).html(Math.round(med_pes * 100) / 100);
           atualizaTotal();
            
        });

        $('.dias-perm').change(function(){
            
            var index= $(this).attr('z-index');
            var dias = parseInt($('.dias-ut[z-index=' + index + ']').val());
            var cons = parseInt($('input[name=litros-' + index + ']').val());
            var fixa = parseInt($('#fixa').val());
            var flut = parseInt($('.pop-flu[z-index=' + index + ']').val());
            var perm = parseInt($('.dias-perm[z-index=' + index + ']').val());
            if(perm > dias || perm == "") $('.dias-perm[z-index=' + index + ']').val(dias);
            var med_dia = (dias > 0 ) ? cons/dias : cons;
            var med_pes = cons/(fixa * dias + flut * perm);
            $('#TR-D'+ index).html(Math.round(med_dia * 100) / 100);
            $('#TR-P'+ index).html(Math.round(med_pes * 100) / 100);
           atualizaTotal();
            
        });
        
        function atualizaTotal(){
            
            var fixa = parseInt($('#fixa').val());
            var flut = 0;
            var dias = 0;
            var perm = 0
            var litros = 0;
            $('.pop-flu').each(function(){
                
                flut += parseInt($(this).val());
                
            });
            $('.dias-ut').each(function(){
                
                dias += parseInt($(this).val());
                
            });
            $('.dias-perm').each(function(){
                
                perm += parseInt($(this).val());
                
            });
            $('.litros').each(function(){
                
                litros += parseInt($(this).val());
                
            });
            $('#tot-dias').text(dias);
            $('#tot-perm').text(perm);
            $('#tot-flut').text(flut);
            var med_dia = (dias > 0 ) ? litros/dias : litros;
            var med_pes = litros / (fixa * dias + flut * perm); //TODO verificar maneira adequada de realizar esta conta
            $('#med-l-dia').text(Math.round(med_dia * 100) / 100);
            $('#med-p-dia').text(Math.round(med_pes * 100) / 100);
            
            drawComparacao(Math.round(med_pes * 100) / 100);
            
        }
        
        function runMiddlewares(){
            
            atualizaTotal();
            
        }
        
        /*
         * Alterando conteúdo ao abrir Modal
         */
        $('.open-modal').click(function(){
            
            var index = $(this).attr('href');
            $('#myModalLabel').html($('#dia-semana-' + index).html() + " " + $(this).html());
            
            var med = $('#modal-med-' + index).text();
            $('#modal-med').html(med);
            
            var obs = $('input[name=modal-obs-'+ index +']').val();
            obs = (obs != "") ? obs: "Nada consta";
            $('#modal-obs').html(obs);
            
            var con = $('#modal-con-' + index).text();
            $('#modal-con').html(con);
            
            var dia = $('.dias-ut[z-index=' + index + ']').val();
            $('#modal-dia').html(dia);
            
            var pes = $('.pop-flu[z-index=' + index + ']').val();
            var perm = $('.dias-perm[z-index=' + index + ']').val();
            $('#modal-pes').html( $('#fixa').val());
            $('#modal-flu').html( pes + " em " + perm + " dias"); //CONTINUA?
            
            $('#modal-username').html($('input[name=modal-user-' + index + ']').val());
            $('#modal-mld').html($('#TR-D' + index).text());
            $('#modal-mpd').html($('#TR-P' + index).text());
            
            var end = $('.dias-ut[z-index=' + index + ']').attr('max');
            var begin = new Date( $('input[name=begin-date-' + index + ']').val() );
            var value = parseFloat($('#TR-P' + index).text());
            drawModalChart(begin, end, value);
            
            $('#show-chart').html($('#modal-chart').html());
            
            $('#modal-chart').html("");
            
        });
        
        
        runMiddlewares();
        
        /*
         * Enviando POST do form de leituras
         */
        $("#form-leitura").submit(function(e){
            
            e.preventDefault();
            
            var invalid  = 0;
            var alert_txt= "";
            var leitura  = $('#hidrometro');
            var flutuante= $('#flutuante');
            var permanencia = $('#permanencia');
            var observacao  = $('#obs-leitura').val();
            var user        = $('#username').val();
            var ucid        = $('#ucid').val();
            
            if( leitura.val() <= leitura.attr('min') || leitura.val() == "" ){
                
                invalid++;
                alert_txt += invalid + " - A medição digitada deve ser maior que " + leitura.attr('min') + ".<br />";
                
            }
            if(flutuante.val() == ""){
                
                flutuante.val(0);
                
            }
            if( (flutuante.val() > 0 && permanencia.val() < 1) || (flutuante.val() < 1 && permanencia.val() > 0) ){
                
                invalid++;
                alert_txt += invalid + " - Se a Pop. Flutuante for maior que 1, deve-se preencher o campo Permanência e vice e versa.<br />";
                
            }
            
            if(invalid > 0){
                
                $('#leitura-alert-message').html(alert_txt);
                $('#form-leitura-alert').show();
                
            }else{

                $.post('actions.php', 
                    {action: "salvar-leitura", 
                     leitura: leitura.val(), 
                     user: user, 
                     ucid:ucid,
                     flutuante: flutuante.val(),
                     permanencia: permanencia.val(),
                     observacao: observacao
                    }, //Callback
                function(data){
                        
                    //$('#callback').html(data);
                    if(data == 1){
                        
                        $('#conteudo').load('src/painel_uc/medicao.php', function(){
                            drawChart();
                            drawChart2();
                        });
                        
                    }else{
                        
                        $('#leitura-alert-message').html(data);
                        $('#form-leitura-alert').show();
                
                    }
                        
                });
                
            }
            
        });
        
        /*
         * Verifica se arquivo existe
         */ /*
        $.ajax({
            url:'actions.php',
            type:'HEAD',
            success: function() {
                alert('sim');
            },
            error: function() {
                alert('nao');
            }
        }); */
    });

</script>

    <!-- BEGIN NORESULTS -->
    <div class="alert alert-danger">
        Não foram encontradas medições para o este período. <strong><a href="src/painel_uc/medicao.php" class="muda-periodo">Clique aqui para voltar para mais recente</a></strong>
    </div>
    <div id="chart_med" class="hidden"></div>
    <div id="chart_meta" class="hidden"></div>
    <div id="compara_chart" class="hidden"></div>
    <!-- END NORESULTS -->
    <!-- BEGIN RESULTS -->
<div class="row" id="grafico">
    <div class="col-md-8">
        <h2>RGI {UCNOME}</h2>    
    </div>
    <div class="col-md-4" align="right">
        <h2>Data: {DATA_HOJE}</h2>
    </div>
</div>

<div class="container rounded" style="padding:15px; margin-top: 27px">
    <div class="col-md-12">
        <div class="row">
            <div class="col-md-4" style="padding-top:6px">
                <h4>RGI: <kbd>{UCNOME}</kbd></h4>
            </div>
            <div class="col-md-4 text-center">
                <h1>{REFERENCIAC} </h1><small>(Total de <b>{PERIODO}</b> dias) <i>mês de referência da nota pela empresa</i></small>
            </div>
            <div class="col-md-4" align="right">
                <h4>
                    <a href="src/painel_uc/medicao.php?mes={MES_ANT}&ano={ANO_ANT}" class="btn btn-warning muda-periodo"><i class="fa fa-2x fa-arrow-circle-left"></i></a> 
                    <span style="text-decoration: underline">{DATA_INI} a {DATA_FIN}</span> 
                    <a href="src/painel_uc/medicao.php?mes={MES_POS}&ano={ANO_POS}" class="btn btn-warning muda-periodo"><i class="fa fa-2x fa-arrow-circle-right"></i></a>
                </h4>
            </div>
        </div>
        <div class="row">
            <div id="chart_med" style="margin-top:15px"></div>
        </div>
    </div>
    <div class="col-md-12">
        <div class="row" style="margin-top:10px;" >
            <div class="col-md-3 col-md-offset-1">
                <a href="src/painel_uc/medicao.php?mes={MES_ANT}&ano={ANO_ANT}" class="btn btn-warning muda-periodo">
                    <b>&Lt; MÊS ANTERIOR</b> <span class="badge">{MES_ANTERIOR}/{ANO_ANT}</span>                
                </a>
            </div>
            <div class="col-md-4" id="chart_meta" style="height: 200px"></div>
            <div class="col-md-3" align="right">
                <a href="src/painel_uc/medicao.php?mes={MES_POS}&ano={ANO_POS}" class="btn btn-warning muda-periodo" id="posterior"> 
                    <b>MÊS POSTERIOR <span class="badge">{MES_POSTERIOR}/{ANO_POS}</span> &Gt;</b>
                </a>
            </div>
        </div>
        <div class="row col-md-10 col-md-offset-1" style="margin-top:25px; margin-bottom:20px">
            <div class="btn-group btn-group-justified" style="">
                <span class="btn btn-lg bg-danger" > Consumo <code>{MES_ANTERIOR}/{ANO_ANT}</code> : <small> {CON_ANTERIOR} {TIPOMEDIDA}</small></span>
                <span class="btn btn-lg bg-success">Consumo <code>{REFERENCIA}</code> : <small>{CON_PERIODO} {TIPOMEDIDA}</small></span>
                <span class="btn btn-lg bg-info" title="Variação em todo o período">Variação: <small>{VAR_PERIODO} %</small></span>
            </div>
        </div>
        <div class="row col-md-10 col-md-offset-1">
            <blockquote>
            <small><i>* As leituras são <b>SEMPRE CUMULATIVAS</b>. Caso exista uma redução no gráfico, provavelmente houve erro na leitura da conta e será necessária uma investigação.</i></small>
            </blockquote>
        </div>
        
    </div>
    <div class="col-md-12">
        <div class="well">
            <h4><span class=""></span>Informações da Nota : <b>{REFERENCIA}</b></h4>
            {TESTE}
            <!-- BEGIN NOTA_BLOCK -->
            <blockquote>
                <div class="row">

                <ul class="list-group">

                    <li class="list-group-item"><samp><strong>Data de Lançamento:</strong> {NDATA_LANCTO}</samp></li>
                    <li class="list-group-item list-group-item-success"><samp><strong>Data da Leitura:</strong> {NDATA_LEITURA}</samp></li>
                    <li class="list-group-item list-group-item-danger"><samp><strong>Leitura: {NLEITURA} {TIPOMEDIDA}</strong></samp></li>
                    <li class="list-group-item list-group-item-info"><samp><strong>Consumo Faturado: {NCONSUMO} {TIPOMEDIDA}</strong></samp></li>
                    <li class="list-group-item list-group-item-info"><samp><strong>Valor Faturado:</strong> R$ {NVALOR}</samp></li>

                </ul>
                </div>
            </blockquote>
            <!-- END NOTA_BLOCK -->
            <!-- BEGIN SNOTA_BLOCK -->
            <div class="alert alert-warning">A nota ainda não foi lançada no sistema</div>
            <!-- END SNOTA_BLOCK -->
        </div>

    </div>
</div> 
    
<!-- END RESULTS -->